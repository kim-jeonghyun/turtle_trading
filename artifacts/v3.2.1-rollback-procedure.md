# v3.2.1 롤백 절차서

**버전:** v3.2.1
**작성일:** 2026-02-22
**문서 상태:** 승인됨 — 배포 전 사전 준비 완료 필요
**대상 독자:** 시스템 운영자, 온콜 담당자

---

## 개요

이 문서는 v3.2.1 배포 후 심각한 장애 발생 시 이전 안정 버전으로 되돌리는 절차를 기술한다.

### v3.2.1 변경 사항 요약

| 변경 | 설명 | 관련 이슈 |
|------|------|-----------|
| `scripts/signal_check.py` 삭제 | crontab을 `check_positions.py`로 완전 전환 | #6 |
| `crontab` 수정 | KR(16:00), US(07:00) 모두 `check_positions.py` 실행 | #6 |
| `_find_matching_fill()` 시간 필터 추가 | `ord_tmd` 기반 fill 매칭 정확도 개선 | #29 |

### 롤백 기준 (언제 롤백할 것인가)

다음 중 하나라도 해당되면 롤백을 실행한다.

- cron job이 스케줄대로 실행되지 않거나 무응답 상태가 지속될 때
- `check_positions.py` 실행 시 반복적인 예외(Exception)가 발생하고 자동 복구되지 않을 때
- Telegram 알림이 2회 연속 스케줄 실행에서 미수신될 때
- 포지션 파일(`positions.json`)이 손상되거나 예상치 못한 방식으로 변경될 때
- `_find_matching_fill()` 변경으로 인해 fill 매칭 오판이 확인될 때 (피라미딩 오작동)

### 롤백 대상 커밋

```
# v3.2.1 시작 커밋 (이 커밋들이 롤백 대상)
203bcee  [#29] _find_matching_fill() 시간 필터 추가
ace20b7  [#6] signal_check.py 삭제 및 crontab 전환

# 롤백 후 목표 커밋 (이전 안정 베이스)
238760b  Merge pull request #24 from kim-jeonghyun/fix/pr-review-followup-hardening
```

---

## 섹션 1: 롤백 전 현재 상태 저장

롤백 전에 반드시 현재 운영 상태를 백업한다. 데이터 볼륨(`./data`, `./logs`)은 컨테이너 재빌드 후에도 보존되지만, 명시적 백업은 필수다.

### 1.1 포지션 파일 백업

```bash
# 타임스탬프 변수 설정
BACKUP_TS=$(date +%Y%m%d_%H%M%S)

# positions.json 백업 (가장 중요한 파일)
cp /Users/momo/dev/turtle_trading/data/positions/positions.json \
   /Users/momo/dev/turtle_trading/data/positions/backups/positions.json.pre-rollback-${BACKUP_TS}

echo "백업 완료: positions.json.pre-rollback-${BACKUP_TS}"
```

### 1.2 로그 스냅샷 저장

```bash
# 최근 KR/US cron 로그 보관 (진단용)
cp /Users/momo/dev/turtle_trading/logs/check_kr.log \
   /Users/momo/dev/turtle_trading/logs/check_kr.log.pre-rollback-${BACKUP_TS}

cp /Users/momo/dev/turtle_trading/logs/check_us.log \
   /Users/momo/dev/turtle_trading/logs/check_us.log.pre-rollback-${BACKUP_TS}
```

### 1.3 실행 중인 컨테이너 상태 확인

```bash
# 현재 컨테이너 상태 확인
docker ps -a --filter name=turtle

# 컨테이너 내부 최근 로그 확인 (문제 진단용)
docker logs --tail 100 turtle-cron
docker logs --tail 50 turtle-dashboard
```

### 1.4 현재 Docker 이미지 태그 기록

```bash
# 현재 사용 중인 이미지 ID 기록 (나중에 참조용)
docker images turtle-trading --format "table {{.ID}}\t{{.Tag}}\t{{.CreatedAt}}"
```

**체크리스트:**
- [ ] `positions.json.pre-rollback-{타임스탬프}` 파일 생성 확인
- [ ] 로그 스냅샷 파일 생성 확인
- [ ] 현재 이미지 ID 기록 완료

---

## 섹션 2: Docker 기반 롤백

배포 스크립트(`deploy-v3.2.1.sh`)가 자동 생성하는 `pre-v3.2.1-backup` 태그 또는 수동 태그 이미지가 로컬에 존재하는 경우 사용한다.

### 2.1 이전 이미지 확인

```bash
# 로컬에 저장된 이미지 목록 확인
docker images turtle-trading

# 예상 출력 예시:
# REPOSITORY       TAG                      IMAGE ID       CREATED        SIZE
# turtle-trading   latest                   abc123def456   2 hours ago    ...
# turtle-trading   v3.2.1                   abc123def456   2 hours ago    ...
# turtle-trading   pre-v3.2.1-backup        def456abc789   3 days ago     ...  ← 롤백 대상
```

### 2.2 이전 이미지로 서비스 전환

```bash
# 서비스 중단
docker-compose -f /Users/momo/dev/turtle_trading/docker-compose.yaml down

# 배포 스크립트가 생성한 백업 태그로 롤백
# (deploy-v3.2.1.sh Step 3에서 자동 생성된 태그)
ROLLBACK_TAG="pre-v3.2.1-backup"

docker run -d \
  --name turtle-cron \
  --env-file /Users/momo/dev/turtle_trading/.env \
  -v /Users/momo/dev/turtle_trading/data:/app/data \
  -v /Users/momo/dev/turtle_trading/logs:/app/logs \
  --restart unless-stopped \
  turtle-trading:${ROLLBACK_TAG}

docker run -d \
  --name turtle-dashboard \
  --env-file /Users/momo/dev/turtle_trading/.env \
  -v /Users/momo/dev/turtle_trading/data:/app/data \
  -v /Users/momo/dev/turtle_trading/logs:/app/logs \
  -p 8501:8501 \
  --restart unless-stopped \
  turtle-trading:${ROLLBACK_TAG} \
  streamlit run app.py --server.port=8501 --server.address=0.0.0.0
```

> `pre-v3.2.1-backup` 태그가 없다면 섹션 3(Git 기반 롤백)으로 이동한다.

---

## 섹션 3: Git 기반 롤백 (권장 절차)

이전 Docker 이미지가 없거나, 코드 레벨에서 완전히 되돌려야 하는 경우 사용한다.

### 3.1 서비스 중단

```bash
cd /Users/momo/dev/turtle_trading

# 모든 컨테이너 중단 및 제거
docker-compose down

# 중단 확인
docker ps --filter name=turtle
# 출력 없음 = 정상 중단
```

### 3.2 롤백 브랜치 생성 및 코드 되돌리기

```bash
cd /Users/momo/dev/turtle_trading

# 현재 상태 확인
git log --oneline -5
git status

# 롤백 브랜치 생성 (main은 직접 수정하지 않음)
git checkout -b rollback/v3.2.1-to-v3.2.0 238760b

# 브랜치 전환 확인
git log --oneline -3
# 예상: 238760b가 HEAD가 되어야 함
```

> 주의: `238760b` 는 v3.2.1 직전 안정 커밋이다.
> PR #24 (`fix/pr-review-followup-hardening`) merge 커밋이 베이스라인이다.

### 3.3 롤백된 소스로 Docker 이미지 재빌드

```bash
cd /Users/momo/dev/turtle_trading

# 이전 버전 이미지 빌드 (태그 명시)
docker build -t turtle-trading:rollback-v3.2.0 .

# 빌드 성공 확인
docker images turtle-trading
```

### 3.4 롤백 이미지로 서비스 재기동

```bash
cd /Users/momo/dev/turtle_trading

# docker-compose.yaml은 build: . 을 사용하므로,
# 방금 빌드한 이미지를 latest로도 태그하여 docker-compose가 사용하게 함
docker tag turtle-trading:rollback-v3.2.0 turtle-trading:latest

# docker-compose로 재기동
docker-compose up -d

# 기동 확인
docker ps --filter name=turtle
# turtle-cron, turtle-dashboard 모두 Up 상태여야 함
```

### 3.5 기동 후 즉시 상태 확인

```bash
# cron 서비스 로그 확인 (기동 에러 없는지)
docker logs --tail 30 turtle-cron

# dashboard 접속 가능 여부 (포트 8501)
curl -s -o /dev/null -w "%{http_code}" http://localhost:8501
# 200 또는 302 응답 = 정상
```

---

## 섹션 4: 롤백 검증

롤백 후 다음 항목을 순서대로 확인한다.

### 4.1 컨테이너 실행 상태 확인

```bash
docker ps --filter name=turtle --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# 예상 출력:
# NAMES              STATUS          PORTS
# turtle-cron        Up X minutes
# turtle-dashboard   Up X minutes    0.0.0.0:8501->8501/tcp
```

### 4.2 crontab 내용 확인 (롤백 여부 검증)

```bash
# 컨테이너 내부 crontab 내용 확인
docker exec turtle-cron crontab -l

# v3.2.0으로 롤백되었다면 signal_check.py 항목이 존재해야 함
# v3.2.1 상태라면 check_positions.py만 존재
# 현재 기대 상태에 맞는지 확인
```

### 4.3 `signal_check.py` 존재 여부 확인 (롤백 판별 기준)

```bash
# 롤백 후에는 signal_check.py가 컨테이너 내에 존재해야 함
docker exec turtle-cron ls /app/scripts/ | grep signal

# 예상 출력 (롤백 성공):
# signal_check.py
```

### 4.4 positions.json 무결성 확인

```bash
# 포지션 파일이 손상 없이 존재하는지 확인
docker exec turtle-cron python -c "
import json
with open('/app/data/positions/positions.json') as f:
    data = json.load(f)
print(f'포지션 파일 정상: {len(data)} 항목')
"

# 또는 호스트에서 직접 확인
python3 -c "
import json
with open('/Users/momo/dev/turtle_trading/data/positions/positions.json') as f:
    data = json.load(f)
print(f'포지션 파일 정상: {len(data)} 항목')
"
```

### 4.5 수동 실행 테스트 (cron 대기 없이 즉시 검증)

```bash
# 컨테이너 내에서 check_positions.py 또는 signal_check.py 직접 실행
# (롤백된 버전에 맞는 스크립트 실행)
docker exec turtle-cron python /app/scripts/check_positions.py

# 실행 로그 확인 (에러 없이 "체크 완료" 또는 동등 메시지 출력 확인)
docker logs --tail 50 turtle-cron
```

### 4.6 테스트 스위트 실행 (코드 레벨 검증)

```bash
cd /Users/momo/dev/turtle_trading

# 롤백된 브랜치에서 전체 테스트 실행
source .venv/bin/activate
pytest -q

# 통과 기준:
# - 0 failed
# - 모든 핵심 모듈(risk, position_tracker, kis_api) 테스트 통과
```

### 4.7 Telegram 알림 수신 확인

다음 스케줄 실행 시간까지 대기하거나, 수동으로 트리거하여 Telegram 알림이 정상 수신되는지 확인한다.

- KR 시장: 평일 16:00 KST
- US 시장: 평일 07:00 KST (화~토)

```bash
# 로그에서 Telegram 발송 성공 메시지 확인
docker logs turtle-cron 2>&1 | grep -i "telegram\|notification\|알림"
```

### 검증 체크리스트

- [ ] `docker ps`에서 turtle-cron, turtle-dashboard 모두 `Up` 상태
- [ ] crontab 내용이 롤백 대상 버전과 일치
- [ ] `positions.json` 파일 정상 로드 (JSON 파싱 성공)
- [ ] 수동 스크립트 실행 시 예외 없이 완료
- [ ] `pytest` 전체 통과 (0 failed)
- [ ] Telegram 알림 수신 확인 (다음 스케줄 또는 수동 트리거)

---

## 섹션 5: 긴급 연락처 및 에스컬레이션

### 5.1 에스컬레이션 기준

| 상황 | 조치 |
|------|------|
| 롤백 후에도 cron 실행 실패 | 즉시 에스컬레이션 (L2) |
| `positions.json` 손상 또는 불일치 | 거래 즉시 중단 후 에스컬레이션 |
| Telegram 알림 연속 2회 미수신 | 수동 점검 후 에스컬레이션 |
| 포지션 청산 오판 의심 | 즉시 수동 포지션 점검 후 에스컬레이션 |

### 5.2 연락처 (플레이스홀더)

| 역할 | 담당자 | 연락처 |
|------|--------|--------|
| 시스템 운영 (L1) | [담당자 이름] | [연락처] |
| 기술 리드 (L2) | [담당자 이름] | [연락처] |
| 긴급 브로커 연락처 | 한국투자증권 | [KIS 고객센터] |

### 5.3 관련 문서 참조

- 운영 가이드: `CLAUDE.md` 섹션 10 (실거래 중 체크리스트)
- 배포 계획 원문: `.sisyphus/plans/council-remediation-plan.md`
- Phase 1 검증 체크리스트: `.sisyphus/plans/council-remediation-plan.md` Task 1.2.3

---

## 부록: 빠른 참조 (Quick Reference)

### 전체 롤백 명령 시퀀스 (복사/붙여넣기용)

```bash
# === 롤백 시작 ===
cd /Users/momo/dev/turtle_trading
BACKUP_TS=$(date +%Y%m%d_%H%M%S)

# 1. 상태 백업
cp data/positions/positions.json \
   data/positions/backups/positions.json.pre-rollback-${BACKUP_TS}

# 2. 서비스 중단
docker-compose down

# 3. 이전 커밋으로 전환 (rollback 브랜치)
git checkout -b rollback/v3.2.1-to-v3.2.0 238760b

# 4. 이미지 재빌드
docker build -t turtle-trading:rollback-v3.2.0 .
docker tag turtle-trading:rollback-v3.2.0 turtle-trading:latest

# 5. 서비스 재기동
docker-compose up -d

# 6. 즉시 검증
docker ps --filter name=turtle
docker logs --tail 30 turtle-cron
# === 롤백 완료 ===
```

### 주요 파일 경로 참조

| 경로 | 설명 |
|------|------|
| `data/positions/positions.json` | 운영 포지션 파일 (가장 중요) |
| `data/positions/backups/` | 포지션 백업 디렉토리 |
| `logs/check_kr.log` | KR 시장 cron 실행 로그 |
| `logs/check_us.log` | US 시장 cron 실행 로그 |
| `logs/daily_report.log` | 일일 리포트 실행 로그 |
| `docker-compose.yaml` | 서비스 구성 파일 |
| `Dockerfile` | 이미지 빌드 정의 |
| `crontab` | cron 스케줄 정의 (이미지에 복사됨) |

---

*이 문서는 v3.2.1 배포 시점에 작성되었으며, 이후 버전 변경 시 갱신이 필요하다.*
